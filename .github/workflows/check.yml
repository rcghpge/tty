---
name: PKGBUILD Check
on: [push, pull_request]

jobs:
  verify:
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - uses: actions/checkout@v4

      - name: Install pacman toolchain
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel devtools pacman-contrib sudo git make

      - name: Generate build user
        run: |
          useradd -m -G wheel builder
          echo "builder ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/builder
          chown -R builder:builder .

      - name: Update checksums
        run: sudo -u builder bash -c "find . -name PKGBUILD -execdir updpkgsums \; || true"

      - name: Verify sources
        run: |
          sudo -u builder bash -c "
            find . -name PKGBUILD -execdir makepkg --verifysource --nobuild \; || {
              echo 'Verification Failed'
              exit 1
            }
          "

      - name: Generate SRCINFO
        run: sudo -u builder bash -c "find . -name PKGBUILD -execdir makepkg --printsrcinfo > .SRCINFO \;"

      - name: Create Makefile
        run: |
          printf '.PHONY: verify srcinfo test-all clean\n\nverify:\n\tfind . -name PKGBUILD -execdir bash -c '\''updpkgsums && makepkg --verifysource --nobuild'\'' \; || (echo "Verification FAILED"; exit 1)\n\nsrcinfo:\n\tfind . -name PKGBUILD -execdir makepkg --printsrcinfo > .SRCINFO \;\n\ntest-all: verify srcinfo\n\t@echo "All tests passed"\n\nclean:\n\trm -f .SRCINFO *.pkg.tar.*\n' > Makefile
          chown builder:builder Makefile

      - name: Test Makefile
        run: sudo -u builder make test-all

      - name: Show results
        run: |
          echo "âœ“ All PKGBUILDs verified!"
          find . -name .SRCINFO -exec head -5 {} \; || true
